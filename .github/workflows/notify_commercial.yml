name: Notify maintainers on commercial requests (Slack / Email)

on:
  issues:
    types: [opened, labeled]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      TO_EMAIL: ${{ secrets.TO_EMAIL }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}
    steps:
      - name: Check if this is a commercial request
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue || {};
            const labels = (issue.labels || []).map(l=> l.name.toLowerCase());
            const title = (issue.title || '').toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const isCommercial = labels.includes('commercial-request') || title.includes('commercial') || body.includes('commercial distribution') || body.includes('commercial');
            return { isCommercial };

      - name: Cancel if not commercial
        if: ${{ fromJson(steps.check.outputs.result).isCommercial == false }}
        run: |
          echo "Not a commercial request — skipping notifications."

      - name: Notify Slack (if SLACK_WEBHOOK_URL set)
        if: env.SLACK_WEBHOOK_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            const webhook = process.env.SLACK_WEBHOOK_URL;
            if (!webhook) {
              console.log('No Slack webhook configured — skipping.');
              return;
            }
            const issue = context.payload.issue;
            const payload = {
              text: `New commercial request: <${issue.html_url}|${issue.title}>\nOpened by: ${issue.user.login}`
            };
            // use the global fetch available in the runner
            await fetch(webhook, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-type':'application/json' } });

      - name: Send email (SMTP) if configured
        if: env.SMTP_HOST != '' && env.SMTP_USERNAME != '' && env.SMTP_PASSWORD != '' && env.TO_EMAIL != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_HOST }}
          server_port: ${{ env.SMTP_PORT || 587 }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "Commercial permission request: ${{ github.event.issue.title }}"
          body: |
            A commercial permission request was opened in the repository.
            Title: ${{ github.event.issue.title }}
            URL: ${{ github.event.issue.html_url }}
            Opened by: ${{ github.event.issue.user.login }}
          to: ${{ env.TO_EMAIL }}
          from: ${{ env.SMTP_FROM || env.TO_EMAIL }}

      - name: Add internal note comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number, body: 'Maintainers have been notified of this commercial request (Slack/email).'});
