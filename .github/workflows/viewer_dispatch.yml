name: Dispatch viewer (self-hosted GUI runner)

# NOTE: This workflow is intended to run on a self-hosted runner that has a GUI/X session
# and where running GUI programs is allowed. GitHub-hosted runners cannot display a GUI
# or open windows on your desktop. Use this workflow only on a self-hosted machine you control.

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Start mode (default: normal)'
        required: false
        default: 'normal'

jobs:
  run-viewer:
    runs-on: self-hosted
    env:
      VIEWER_PASSWORD: ${{ secrets.VIEWER_PASSWORD }}
      VIEWER_DURATION: ${{ secrets.VIEWER_DURATION }}
      VIEWER_ASCII_SECONDS: ${{ secrets.VIEWER_ASCII_SECONDS }}
      VIEWER_WHITELIST: ${{ secrets.VIEWER_WHITELIST }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create .env from repository secrets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p viewer
          # Use job env vars (populated from repository secrets) to avoid inline expression parsing issues
          PASSWORD="${VIEWER_PASSWORD:-}"
          DURATION="${VIEWER_DURATION:-30}"
          ASCII_SECONDS="${VIEWER_ASCII_SECONDS:-3}"
          WHITELIST="${VIEWER_WHITELIST:-}"
          cat > viewer/.env <<'EOF'
PASSWORD=${PASSWORD}
DURATION=${DURATION}
ASCII_SECONDS=${ASCII_SECONDS}
WHITELIST=${WHITELIST}
EOF

      - name: Run viewer (local Electron app)
        shell: bash
        run: |
          cd viewer
          npm ci
          # This will start the electron app on the self-hosted runner.
          # The runner must be a machine with a graphical session and available display.
          npm run start
