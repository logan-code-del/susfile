<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Susfile Viewer</title>
    <style>
      body { font-family: system-ui, Arial; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; }
      .card { width: 90%; max-width:420px; border:1px solid #ddd; padding:20px; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
      .timer { font-size: 2rem; text-align:center; margin-bottom:16px; }
      label, input { display:block; width:100%; }
      input { padding:8px; margin-top:6px; margin-bottom:10px; }
      button { padding:8px 12px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Secure Viewer</h2>
      <div id="asciiOverlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#0f0;z-index:9999;">
        <pre id="asciiArt" style="font-family: monospace; font-size:10px; transform: scale(3); transition: transform 1s ease; text-align:center;">  _____  _   _  _____ _  __
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣾⠟⠛⠛⠿⣷⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⢸⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⡿⠀⠀⠀⠀⠀⠰⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⠨⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⠈⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⢐⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⡇⠀⠀⠀⠀⠀⠠⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡇⠀⠀⠀⠀⠀⢸⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⡇⠀⠀⠀⠀⠀⢰⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣾⡿⠿⢿⣿⣿⠃⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢀⣾⡿⠋⠀⠀⠀⠹⣿⠀⠀⠀⠀⠀⠀⢸⣿⣷⣶⣦⣄⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣼⣿⠃⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠈⣿⠛⠉⠉⠙⢿⣧⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⣼⣿⡿⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⢹⣷⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⢀⣴⣿⠿⣿⠇⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠘⣿⠛⠲⢦⣤⠀⠀⠀⠀⠀
⠀⠀⣰⣿⠟⠁⠀⣿⠀⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⣿⡆⠀⠀⠹⣧⡀⠀⠀⠀
⢀⣼⠟⠅⠀⠀⢸⣿⠀⠀⠀⠀⠀⠀⠸⠟⠁⠀⠀⠀⠀⠀⠑⠿⠃⠀⠀⠀⠀⠀⢹⣇⠀⠀⠀⠹⣧⠀⠀⠀
⣾⠏⠀⠀⠀⠀⢸⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡆⠀⠀⠀⢽⣧⠀⠀
⣿⠀⠀⠀⠀⠀⣸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠛⠃⠀⠀⠀⠀⣿⣆⠀
⣿⣆⠀⠀⠀⠀⠙⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡀
⠹⣿⣷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⡇
⠀⠈⢻⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠇
⠀⠀⠀⠙⢿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⡟⠀
⠀⠀⠀⠀⠀⠙⣿⣷⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⣿⠟⠁⠀
⠀⠀⠀⠀⠀⠀⠈⠹⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣾⡿⠋⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⣿⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⣿⠏⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠃⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⡇⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣿⣶⣶⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣶⣶⣶⣿⠿⠃⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⣀⣀⡀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀
        </pre>
      </div>

      <div id="mainContent" style="display:none;">
        <div class="timer" id="timer">00:30</div>

        <div>
          <label for="password">Enter password to close</label>
          <input id="password" autocomplete="off" type="password" placeholder="password">
          <button id="unlockBtn">Unlock Now</button>
        </div>

        <p style="font-size:0.9rem; color:#666; margin-top:12px">This window may only be closed when the timer ends or the correct password is entered. If you need to force-stop it, kill the process from Task Manager / Activity Monitor.</p>
      </div>
    </div>

    <script>
      // Read config via secure preload API and do credential verification via preload so secrets are not exposed
      const cfg = (window.electronAPI && window.electronAPI.getConfig) ? window.electronAPI.getConfig() : { duration: 30, asciiSeconds: 3 };
      const osUser = (window.electronAPI && window.electronAPI.osUser) || '';
      const duration = Number(cfg.duration) || 30; // seconds
      const asciiSeconds = Number(cfg.asciiSeconds) || 3;
      let remaining = duration;

      // Show ASCII overlay, then reveal content
      const asciiOverlay = document.getElementById('asciiOverlay');
      const asciiArt = document.getElementById('asciiArt');
      const mainContent = document.getElementById('mainContent');

      // Start by showing ascii overlay and zooming out
      setTimeout(() => {
        // zoom the ascii art out
        asciiArt.style.transform = 'scale(1)';
      }, 100);

      setTimeout(() => {
        asciiOverlay.style.display = 'none';
        mainContent.style.display = 'block';
      }, asciiSeconds * 1000);

      const timerEl = document.getElementById('timer');
      const pwInput = document.getElementById('password');
      const btn = document.getElementById('unlockBtn');

      function format(s) {
        const mm = Math.floor(s / 60).toString().padStart(2,'0');
        const ss = (s % 60).toString().padStart(2,'0');
        return `${mm}:${ss}`;
      }

      timerEl.textContent = format(remaining);

      const timer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(timer);
          timerEl.textContent = '00:00';
          // notify main process to allow close
          if (window.electronAPI && window.electronAPI.unlock) {
            window.electronAPI.unlock('timer');
          }
        } else {
          timerEl.textContent = format(remaining);
        }
      }, 1000);

      btn.addEventListener('click', async () => {
        const pw = pwInput.value || '';
        const ghUser = document.getElementById('github_user').value || '';
        if (window.electronAPI && window.electronAPI.verifyCredentials) {
          const result = window.electronAPI.verifyCredentials(ghUser.trim(), pw);
          if (result.allowed) {
            await window.electronAPI.unlock(result.isWhitelisted ? 'whitelist' : 'password');
            return;
          }
        }
        alert('Incorrect credentials or not whitelisted.');
      });

      // Add a GitHub username field to the UI so whitelist can be GitHub users
      const ghLabel = document.createElement('label');
      ghLabel.setAttribute('for','github_user');
      ghLabel.textContent = 'GitHub username (if whitelisted)';
      const ghInput = document.createElement('input');
      ghInput.id = 'github_user';
      ghInput.placeholder = 'github-username';
      ghInput.style.marginTop = '8px';
      ghInput.style.marginBottom = '8px';
      mainContent.insertBefore(ghLabel, mainContent.children[1]);
      mainContent.insertBefore(ghInput, mainContent.children[2]);

      // Optional: when user tries to close window, show a brief message
      if (window.electronAPI && window.electronAPI.onCloseAttempt) {
        window.electronAPI.onCloseAttempt(() => {
          // briefly flash the card or show message
          alert('Window cannot be closed yet. Wait for the timer or enter the password.');
        });
      }
    </script>
  </body>
</html>
